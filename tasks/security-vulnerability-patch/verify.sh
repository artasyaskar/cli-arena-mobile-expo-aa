#!/usr/bin/env bash
set -euo pipefail

echo "üî• Verifying 'Patch a Critical Security Vulnerability' Task"
echo "=========================================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

FAILED=0

# --- Verification Steps ---

# 1. Check the pom.xml for the updated dependency version
echo "1. Checking pom.xml for the updated log4j-core version..."
LOG4J_VERSION=$(grep -A 2 -B 1 "<artifactId>log4j-core</artifactId>" app/pom.xml | grep version | sed -n 's/.*<version>\(.*\)<\/version>.*/\1/p' | tr -d '[:space:]')

if [[ -z "$LOG4J_VERSION" ]]; then
    echo -e "${RED}‚ùå Could not find the version for log4j-core in pom.xml.${NC}"
    FAILED=1
else
    if [[ "$LOG4J_VERSION" == "2.14.1" ]]; then
        echo -e "${RED}‚ùå log4j-core version is still the vulnerable version ($LOG4J_VERSION).${NC}"
        FAILED=1
    else
        echo -e "${GREEN}‚úÖ log4j-core version in pom.xml is updated to a non-vulnerable version ($LOG4J_VERSION).${NC}"
    fi
fi

# 2. Compile the application using Maven
echo "2. Compiling the application with 'mvn compile'..."
if ! mvn -f app/pom.xml -q compile > /tmp/mvn_compile.log 2>&1; then
    echo -e "${RED}‚ùå Maven compilation failed. Check the logs below.${NC}"
    cat /tmp/mvn_compile.log
    exit 1 # Exit early if it doesn't compile
fi
echo -e "${GREEN}‚úÖ Application compiled successfully.${NC}"

# 3. Run the regression and integration tests using Maven
echo "3. Running tests with 'mvn test'..."
if mvn -f app/pom.xml -q test; then
    echo -e "${GREEN}‚úÖ All tests (including logging integration test) passed.${NC}"
else
    echo -e "${RED}‚ùå Tests failed. Your change might have broken existing functionality.${NC}"
    FAILED=1
fi

# 4. Advanced Security Scan: Check dependency tree for the vulnerable JAR
echo "4. Running advanced security scan (checking dependency tree)..."
if mvn -f app/pom.xml dependency:tree | grep "log4j-core:jar:2.14.1"; then
    echo -e "${RED}‚ùå Security scan failed: The vulnerable log4j-core:2.14.1 JAR is still present in the dependency tree.${NC}"
    FAILED=1
else
    echo -e "${GREEN}‚úÖ Security scan passed: Vulnerable log4j-core JAR not found in dependency tree.${NC}"
fi


# --- Final Summary ---
echo "------------------------------------------------------"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}üéâ All verification checks passed! The vulnerability has been patched!${NC}"
    exit 0
else
    echo -e "${RED}‚ùå Some verification checks failed. Please review the errors above.${NC}"
    exit 1
fi
